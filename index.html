<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crime Predictor Dashboard</title>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Geosearch -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.css" />
    <script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.umd.js"></script>

    <!-- H3-js -->
    <script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>

    <!-- Leaflet.heat -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        #map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        #dashboard { z-index: 1000; max-height: 95vh; overflow-y: auto; }
        
        /* Risk Gauge Styles */
        #risk-gauge-container {
            position: relative;
            width: 250px;
            height: 125px;
            margin: 0 auto;
            overflow: hidden;
        }
        .gauge-arc {
            position: absolute;
            bottom: 0;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border-width: 40px;
            border-style: solid;
            box-sizing: border-box;
        }
        #red-arc { 
            border-color: #dc2626 transparent transparent transparent; 
            clip: rect(auto, 125px, 125px, 0);
        }
        #yellow-arc { 
            border-color: #eab308 transparent transparent transparent; 
            clip: rect(auto, 166.6px, 125px, 83.3px);
        }
        #green-arc { 
            border-color: #22c55e transparent transparent transparent; 
            clip: rect(auto, 250px, 125px, 125px);
        }
        
        .loading-spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #22c55e;
            border-right: 6px solid #eab308;
            border-bottom: 6px solid #dc2626;
            border-left: 6px solid #f3f3f3;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans bg-gray-100">

    <div id="map"></div>

    <!-- Dashboard -->
    <div id="dashboard" class="absolute top-4 right-4 bg-white rounded-lg shadow-2xl max-w-md w-80 p-5">
        <!-- Header -->
        <div class="mb-4">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üö® Crime Risk Analyzer</h2>
                    <p class="text-xs text-gray-500">AI-powered crime risk prediction</p>
                </div>
                <button id="dark-mode-btn" 
                        class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-3 rounded text-xs transition duration-200">
                    üåô Dark Mode
                </button>
            </div>
        </div>

        <!-- Step 1: Location Selection -->
        <div id="step-location" class="mb-4">
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-3">
                <h3 class="text-sm font-bold text-blue-700 mb-1">üìç Step 1: Select Location</h3>
                <p class="text-xs text-blue-600">Choose where to analyze crime risk</p>
            </div>
            
            <!-- Search Bar Container -->
            <div id="search-container" class="mb-3">
                <!-- Geosearch will insert here -->
            </div>
            
            <!-- Quick Action Buttons -->
            <div class="grid grid-cols-2 gap-2 mb-3">
                <button id="my-location-btn" 
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded text-xs transition duration-200">
                    üìç My Location
                </button>
                <button id="bangalore-preset-btn" 
                        class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded text-xs transition duration-200">
                    üèôÔ∏è Bangalore
                </button>
            </div>
            
            <!-- Route Analysis Button -->
            <button id="analyze-route-btn" 
                    class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg transform hover:scale-105 mb-3">
                üõ£Ô∏è Analyze My Route
            </button>
            
            <!-- Selected Location Display -->
            <div id="selected-location-display" class="hidden bg-green-50 border border-green-200 rounded p-3 mb-3">
                <p class="text-xs font-semibold text-green-700">‚úÖ Location Selected:</p>
                <p id="location-name" class="text-sm text-green-800 font-medium mt-1"></p>
                <p id="location-coords" class="text-xs text-green-600 mt-1"></p>
            </div>
            
            <!-- Predict Button -->
            <button id="predict-btn" 
                    disabled
                    class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 
                           disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed 
                           text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg transform hover:scale-105">
                üîÆ Analyze Risk
            </button>
            <p class="text-xs text-gray-400 mt-2 text-center" id="predict-helper">
                Select a location to enable analysis
            </p>
        </div>

        <!-- Step 2: Analysis Results (Hidden Initially) -->
        <div id="step-results" class="hidden">
            <div class="bg-purple-50 border-l-4 border-purple-500 p-3 mb-4">
                <h3 class="text-sm font-bold text-purple-700 mb-1">üìä Step 2: Risk Analysis</h3>
                <p class="text-xs text-purple-600">Comprehensive area assessment</p>
            </div>
            
            <!-- Results Content -->
            <div id="results-content">
                <!-- Risk Score Display -->
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 mb-4 text-center">
                    <p class="text-xs text-gray-500 mb-2">Overall Risk Score</p>
                    <div class="text-6xl font-bold mb-2" id="risk-percentage">-</div>
                    <p class="text-sm font-semibold mb-1" id="risk-level-text">Calculating...</p>
                    <p class="text-xs text-gray-500" id="risk-description"></p>
                </div>
                
                <!-- Three-Layer Breakdown -->
                <div class="space-y-2 mb-4">
                    <h4 class="text-xs font-bold text-gray-700 mb-2">Risk Factor Breakdown:</h4>
                    
                    <!-- Layer 1: Historical -->
                    <div class="bg-white border-l-4 border-blue-500 rounded p-2">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-semibold text-gray-700">üïê Historical</span>
                            <span id="historical-score" class="text-sm font-bold text-blue-600">-</span>
                        </div>
                        <p id="historical-details" class="text-xs text-gray-500 mt-1">2001-2014 crime patterns</p>
                    </div>
                    
                    <!-- Layer 2: Environmental -->
                    <div class="bg-white border-l-4 border-green-500 rounded p-2">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-semibold text-gray-700">üåç Environmental</span>
                            <span id="environmental-score" class="text-sm font-bold text-green-600">-</span>
                        </div>
                        <p id="environmental-details" class="text-xs text-gray-500 mt-1">Real-time POI density</p>
                        <div id="poi-breakdown" class="text-xs text-gray-600 mt-1"></div>
                    </div>
                    
                    <!-- Layer 3: Contextual -->
                    <div class="bg-white border-l-4 border-yellow-500 rounded p-2">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-semibold text-gray-700">üì∞ Contextual</span>
                            <span id="contextual-score" class="text-sm font-bold text-yellow-600">-</span>
                        </div>
                        <p id="contextual-details" class="text-xs text-gray-500 mt-1">Recent crime news</p>
                    </div>
                </div>
                
                <!-- Recent News -->
                <div id="news-section" class="hidden mb-4">
                    <h4 class="text-xs font-bold text-gray-700 mb-2">üì∞ Recent Crime Reports:</h4>
                    <ul id="news-list" class="space-y-1 max-h-32 overflow-y-auto"></ul>
                </div>
                
                <!-- Action Buttons -->
                <div class="space-y-2">
                    <button id="new-analysis-btn" 
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded transition duration-200 text-sm">
                        üîÑ New Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const API_BASE_URL = "http://localhost:8000";  // LOCAL TESTING
        // const API_BASE_URL = "https://find-crime-near-you.onrender.com";  // PRODUCTION
        const ANALYSIS_RADIUS_KM = 2;

        // ===== STATE =====
        let selectedLocation = null;
        let currentRiskData = null;
        let map, marker, riskPolygon, heatmapLayer, analysisCircle;
        let isDarkMode = false;
        let lightTileLayer, darkTileLayer;
        
        // Route analysis state
        let isRouteMode = false;
        let routeStartMarker = null;
        let routeEndMarker = null;
        let routeControl = null;
        let routeRiskSegments = [];
        
        // Cache for risk predictions (speeds up repeat queries)
        const riskCache = new Map();
        const CACHE_PRECISION = 3; // Round to 3 decimal places for cache key

        // ===== DOM ELEMENTS =====
        const myLocationBtn = document.getElementById('my-location-btn');
        const bangalorePresetBtn = document.getElementById('bangalore-preset-btn');
        const predictBtn = document.getElementById('predict-btn');
        const darkModeBtn = document.getElementById('dark-mode-btn');
        const analyzeRouteBtn = document.getElementById('analyze-route-btn');
        const newAnalysisBtn = document.getElementById('new-analysis-btn');
        const selectedLocationDisplay = document.getElementById('selected-location-display');
        const locationName = document.getElementById('location-name');
        const locationCoords = document.getElementById('location-coords');
        const stepLocation = document.getElementById('step-location');
        const stepResults = document.getElementById('step-results');
        const resultsContent = document.getElementById('results-content');

        // ===== INITIALIZE MAP =====
        map = L.map('map').setView([12.9716, 77.5946], 12); // Bangalore center
        
        // Light mode tile layer (default)
        lightTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Dark mode tile layer
        darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors ¬© CARTO'
        });

        // Add search control
        const searchControl = new GeoSearch.GeoSearchControl({
            provider: new GeoSearch.OpenStreetMapProvider(),
            style: 'bar',
            autoComplete: true,
            autoCompleteDelay: 250,
            showMarker: false,
            retainZoomLevel: false,
            animateZoom: true,
            keepResult: true,
            searchLabel: 'Search location...'
        });
        map.addControl(searchControl);

        // ===== EVENT LISTENERS =====
        
        // Geosearch result
        map.on('geosearch/showlocation', (result) => {
            setLocation(result.location.y, result.location.x, result.location.label);
        });

        // My Location button
        myLocationBtn.addEventListener('click', () => {
            myLocationBtn.disabled = true;
            myLocationBtn.textContent = '‚è≥ Getting...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    setLocation(lat, lon, 'Your Current Location');
                    myLocationBtn.disabled = false;
                    myLocationBtn.innerHTML = 'üìç My Location';
                },
                (error) => {
                    alert(`Error: ${error.message}`);
                    myLocationBtn.disabled = false;
                    myLocationBtn.innerHTML = 'üìç My Location';
                }
            );
        });

        // Bangalore preset
        bangalorePresetBtn.addEventListener('click', () => {
            setLocation(12.9716, 77.5946, 'MG Road, Bangalore');
        });

        // Dark mode toggle
        darkModeBtn.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                map.removeLayer(lightTileLayer);
                darkTileLayer.addTo(map);
                darkModeBtn.innerHTML = '‚òÄÔ∏è Light Mode';
                darkModeBtn.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                darkModeBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            } else {
                map.removeLayer(darkTileLayer);
                lightTileLayer.addTo(map);
                darkModeBtn.innerHTML = 'üåô Dark Mode';
                darkModeBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                darkModeBtn.classList.add('bg-gray-700', 'hover:bg-gray-800');
            }
        });

        // Analyze Route button
        analyzeRouteBtn.addEventListener('click', () => {
            if (!isRouteMode) {
                // Enter route mode
                isRouteMode = true;
                analyzeRouteBtn.innerHTML = '‚ùå Cancel Route';
                analyzeRouteBtn.classList.remove('bg-gradient-to-r', 'from-green-500', 'to-emerald-500', 'hover:from-green-600', 'hover:to-emerald-600');
                analyzeRouteBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                
                alert('üõ£Ô∏è Route Mode Active!\n\n1Ô∏è‚É£ Click on the map to set START point\n2Ô∏è‚É£ Click again to set END point\n3Ô∏è‚É£ Watch your route get risk-analyzed!');
                
                // Clear any existing route
                clearRoute();
            } else {
                // Exit route mode
                exitRouteMode();
            }
        });
        
        // Map click handler for route mode
        map.on('click', async (e) => {
            if (!isRouteMode) return;
            
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            if (!routeStartMarker) {
                // Set start point
                routeStartMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: 'üèÅ',
                        className: 'text-2xl',
                        iconSize: [30, 30]
                    })
                }).addTo(map).bindPopup('Start Point').openPopup();
            } else if (!routeEndMarker) {
                // Set end point
                routeEndMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: 'üéØ',
                        className: 'text-2xl',
                        iconSize: [30, 30]
                    })
                }).addTo(map).bindPopup('End Point').openPopup();
                
                // Calculate and analyze route
                await calculateAndAnalyzeRoute();
            }
        });

        // Predict button
        predictBtn.addEventListener('click', async () => {
            if (!selectedLocation) return;
            
            // Hide location selection, show results
            stepLocation.classList.add('hidden');
            stepResults.classList.remove('hidden');
            resultsContent.classList.remove('hidden');
            
            // Clear previous map layers
            clearMapLayers();
            
            // Draw analysis circle (will be colored after risk calculation)
            analysisCircle = L.circle([selectedLocation.lat, selectedLocation.lon], {
                radius: ANALYSIS_RADIUS_KM * 1000,
                color: '#6b7280',
                weight: 2,
                fillColor: '#6b7280',
                fillOpacity: 0.1
            }).addTo(map);
            
            // Fetch risk data
            try {
                console.log('Fetching risk prediction for:', selectedLocation);
                const response = await fetch(`${API_BASE_URL}/predict_risk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: selectedLocation.lat,
                        longitude: selectedLocation.lon
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API returned status: ${response.status}`);
                }
                
                currentRiskData = await response.json();
                console.log('Risk data received:', currentRiskData);
                displayRiskResults(currentRiskData);
                
                // Auto-load hotspots after risk analysis
                await loadHotspots();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to fetch risk data. Please try again.');
                newAnalysisBtn.click();
            }
        });

        // Load hotspots function (auto-called after risk analysis)
        async function loadHotspots() {
            if (!selectedLocation) return;
            
            try {
                console.log('Fetching hotspots for:', selectedLocation);
                const url = `${API_BASE_URL}/get_hotspots?lat=${selectedLocation.lat}&lon=${selectedLocation.lon}&radius_km=${ANALYSIS_RADIUS_KM}`;
                console.log('Hotspots URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Hotspots API returned status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Hotspots response:', data);
                displayHotspots(data);
                
            } catch (error) {
                console.error('Hotspots error:', error);
                // Silently fail - hotspots are supplementary
            }
        }

        // New analysis button
        newAnalysisBtn.addEventListener('click', () => {
            // Reset state
            selectedLocation = null;
            currentRiskData = null;
            clearMapLayers();
            
            // Show location selection
            stepLocation.classList.remove('hidden');
            stepResults.classList.add('hidden');
            selectedLocationDisplay.classList.add('hidden');
            predictBtn.disabled = true;
            document.getElementById('predict-helper').textContent = 'Select a location to enable analysis';
        });

        // ===== HELPER FUNCTIONS =====
        
        function setLocation(lat, lon, name) {
            selectedLocation = { lat, lon, name };
            
            // Update UI
            selectedLocationDisplay.classList.remove('hidden');
            locationName.textContent = name;
            locationCoords.textContent = `${lat.toFixed(4)}¬∞N, ${lon.toFixed(4)}¬∞E`;
            predictBtn.disabled = false;
            document.getElementById('predict-helper').textContent = 'Ready to analyze!';
            
            // Update map
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon], { draggable: true }).addTo(map);
            map.setView([lat, lon], 14);
            
            // Add drag event listener to update location when marker is moved
            marker.on('dragend', function(e) {
                const newLatLng = e.target.getLatLng();
                setLocation(newLatLng.lat, newLatLng.lng, `Custom Location (Dragged)`);
            });
        }
        
        function displayRiskResults(data) {
            resultsContent.classList.remove('hidden');
            
            // Convert 0-2 scale to 0-100%
            // Safety check for undefined or NaN values
            const rawScore = data.risk_score_raw || data.risk_code || 0;
            const riskPercentage = Math.round((rawScore / 2) * 100);
            
            // Update main display
            document.getElementById('risk-percentage').textContent = `${riskPercentage}%`;
            document.getElementById('risk-percentage').className = `text-6xl font-bold mb-2 ${getRiskColor(riskPercentage)}`;
            document.getElementById('risk-level-text').textContent = getRiskLevel(riskPercentage);
            document.getElementById('risk-description').textContent = data.explanation || 'Risk analysis complete';
            
            // Update three layers
            if (data.layer_scores) {
                const layers = data.layer_scores;
                
                // Historical - Convert score (0-2) to percentage (0-100%)
                const histScore = layers.historical.score || 0;
                const histPercent = Math.round((histScore / 2) * 100);
                document.getElementById('historical-score').textContent = `${histPercent}%`;
                document.getElementById('historical-details').textContent = 
                    `Past crime patterns: ${layers.historical.score === 0 ? 'Low' : layers.historical.score === 1 ? 'Medium' : 'High'} risk`;
                
                // Environmental - Convert score (0-2) to percentage (0-100%)
                const envScore = layers.environmental.score || 0;
                const envPercent = Math.round((envScore / 2) * 100);
                document.getElementById('environmental-score').textContent = `${envPercent}%`;
                document.getElementById('environmental-details').textContent = 
                    `${layers.environmental.poi_count} POIs detected within 500m`;
                
                // POI breakdown
                const poiBreakdown = document.getElementById('poi-breakdown');
                poiBreakdown.innerHTML = '';
                if (layers.environmental.poi_breakdown && layers.environmental.poi_count > 0) {
                    const poi = layers.environmental.poi_breakdown;
                    const items = [];
                    if (poi.bars > 0) items.push(`üç∫ ${poi.bars} bars`);
                    if (poi.nightclubs > 0) items.push(`üéµ ${poi.nightclubs} nightclubs`);
                    if (poi.atms > 0) items.push(`üí∞ ${poi.atms} ATMs`);
                    if (poi.banks > 0) items.push(`üè¶ ${poi.banks} banks`);
                    if (poi.alcohol_shops > 0) items.push(`üç∑ ${poi.alcohol_shops} shops`);
                    poiBreakdown.textContent = items.join(' ‚Ä¢ ');
                }
                
                // Contextual - Convert score (0-2) to percentage (0-100%)
                const ctxScore = layers.contextual.score || 0;
                const ctxPercent = Math.round((ctxScore / 2) * 100);
                document.getElementById('contextual-score').textContent = `${ctxPercent}%`;
                document.getElementById('contextual-details').textContent = 
                    layers.contextual.news_count > 0 
                        ? `${layers.contextual.news_count} recent crime report(s)` 
                        : 'No recent reports';
                
                // News articles
                const newsSection = document.getElementById('news-section');
                const newsList = document.getElementById('news-list');
                if (layers.contextual.news_articles && layers.contextual.news_articles.length > 0) {
                    newsSection.classList.remove('hidden');
                    newsList.innerHTML = layers.contextual.news_articles.map(article => `
                        <li class="text-xs border-b border-gray-200 py-1">
                            <a href="${article.link}" target="_blank" class="hover:text-blue-500">
                                <span class="font-semibold">${article.title}</span><br>
                                <span class="text-gray-400">${article.location || 'Unknown location'}</span>
                            </a>
                        </li>
                    `).join('');
                } else {
                    newsSection.classList.add('hidden');
                }
            }
            
            // Draw H3 hexagon
            if (data.h3_index) {
                const boundary = h3.cellToBoundary(data.h3_index, true);
                riskPolygon = L.polygon(boundary, {
                    color: getHexColor(riskPercentage),
                    weight: 3,
                    fillColor: getHexColor(riskPercentage),
                    fillOpacity: 0.3
                }).addTo(map);
            }
            
            // Update analysis circle color to match risk level
            if (analysisCircle) {
                const riskColor = getHexColor(riskPercentage);
                analysisCircle.setStyle({
                    color: riskColor,
                    fillColor: riskColor
                });
            }
        }
        
        function displayHotspots(data) {
            console.log('Hotspots data received:', data);
            
            if (!data || !data.hotspots) {
                console.error('No hotspots data in response');
                alert('No hotspots data available from server.');
                return;
            }
            
            if (data.hotspots.length === 0) {
                alert('No historical crime records found in this area. This might be a low-crime zone.');
                return;
            }
            
            // Filter out invalid coordinates
            const validHotspots = data.hotspots.filter(crime => {
                const hasLat = crime.latitude != null && !isNaN(parseFloat(crime.latitude));
                const hasLon = crime.longitude != null && !isNaN(parseFloat(crime.longitude));
                return hasLat && hasLon;
            });
            
            console.log(`Valid hotspots: ${validHotspots.length} out of ${data.hotspots.length}`);
            
            if (validHotspots.length === 0) {
                alert('Crime data found, but coordinates are invalid. Database may need updating.');
                return;
            }
            
            // Create heat points with proper coordinates
            const heatPoints = validHotspots.map(crime => [
                parseFloat(crime.latitude), 
                parseFloat(crime.longitude), 
                0.5  // Intensity
            ]);
            
            if (heatmapLayer) map.removeLayer(heatmapLayer);
            
            // Risk-based gradient: Green (low) ‚Üí Yellow (medium) ‚Üí Red (high)
            heatmapLayer = L.heatLayer(heatPoints, {
                radius: 30,
                blur: 25,
                maxZoom: 18,
                max: 1.0,
                gradient: {
                    0.0: '#22c55e',   // Green (low risk)
                    0.4: '#84cc16',   // Light green
                    0.5: '#eab308',   // Yellow (medium risk)
                    0.7: '#f97316',   // Orange
                    1.0: '#dc2626'    // Red (high risk)
                }
            }).addTo(map);
            
            console.log('Heatmap layer added successfully');
        }
        
        function clearMapLayers() {
            if (riskPolygon) { map.removeLayer(riskPolygon); riskPolygon = null; }
            if (heatmapLayer) { map.removeLayer(heatmapLayer); heatmapLayer = null; }
            if (analysisCircle) { map.removeLayer(analysisCircle); analysisCircle = null; }
        }
        
        function getRiskColor(percentage) {
            if (percentage < 33) return 'text-green-600';
            if (percentage < 66) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        function getHexColor(percentage) {
            if (percentage < 33) return '#22c55e';
            if (percentage < 66) return '#eab308';
            return '#dc2626';
        }
        
        function getRiskLevel(percentage) {
            if (percentage < 33) return '‚úÖ LOW RISK AREA';
            if (percentage < 66) return '‚ö†Ô∏è MEDIUM RISK AREA';
            return 'üö® HIGH RISK AREA';
        }
        
        // ===== ROUTE ANALYSIS FUNCTIONS =====
        
        // Fast risk prediction with caching
        async function getRiskForPoint(lat, lon, useFastMode = false) {
            // Create cache key (round to 3 decimals ~111m precision)
            const cacheKey = `${lat.toFixed(CACHE_PRECISION)},${lon.toFixed(CACHE_PRECISION)}`;
            
            // Check cache first
            if (riskCache.has(cacheKey)) {
                return riskCache.get(cacheKey);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/predict_risk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        latitude: lat, 
                        longitude: lon,
                        fast_mode: useFastMode
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const riskPercentage = Math.round((data.risk_score_raw / 2) * 100);
                    
                    // Cache the result
                    riskCache.set(cacheKey, riskPercentage);
                    
                    // Limit cache size to prevent memory issues (keep last 1000)
                    if (riskCache.size > 1000) {
                        const firstKey = riskCache.keys().next().value;
                        riskCache.delete(firstKey);
                    }
                    
                    return riskPercentage;
                } else {
                    return 50; // Default medium risk
                }
            } catch (error) {
                console.error('Error fetching risk:', error);
                return 50;
            }
        }
        
        async function calculateAndAnalyzeRoute() {
            const startLatLng = routeStartMarker.getLatLng();
            const endLatLng = routeEndMarker.getLatLng();
            
            // Create routing control
            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(startLatLng.lat, startLatLng.lng),
                    L.latLng(endLatLng.lat, endLatLng.lng)
                ],
                routeWhileDragging: false,
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                showAlternatives: false,
                lineOptions: {
                    styles: [{color: '#3388ff', opacity: 0.3, weight: 6}]
                },
                createMarker: () => null // Don't create default markers
            }).addTo(map);
            
            // Wait for route to be calculated
            routeControl.on('routesfound', async (e) => {
                const route = e.routes[0];
                const coordinates = route.coordinates;
                
                console.log(`Route found with ${coordinates.length} points`);
                
                // Analyze risk along the route (sample every 10th point to reduce API calls)
                await analyzeRouteRisk(coordinates);
            });
        }
        
        async function analyzeRouteRisk(coordinates) {
            // Clear previous risk segments
            routeRiskSegments.forEach(segment => map.removeLayer(segment));
            routeRiskSegments = [];
            
            // Sample points more aggressively (every 20th point instead of 10th)
            const sampledPoints = [];
            const sampleRate = Math.max(20, Math.floor(coordinates.length / 15)); // Max 15 API calls
            for (let i = 0; i < coordinates.length; i += sampleRate) {
                sampledPoints.push(coordinates[i]);
            }
            // Always include the last point
            if (coordinates[coordinates.length - 1] !== sampledPoints[sampledPoints.length - 1]) {
                sampledPoints.push(coordinates[coordinates.length - 1]);
            }
            
            console.log(`Analyzing ${sampledPoints.length} points along route...`);
            
            // Fetch ALL risks in parallel using cached function with fast_mode
            const riskPromises = sampledPoints.map(point => 
                getRiskForPoint(point.lat, point.lng, true).then(risk => ({
                    lat: point.lat,
                    lng: point.lng,
                    risk: risk
                }))
            );
            
            // Wait for all requests to complete at once
            const riskData = await Promise.all(riskPromises);
            
            // Draw colored segments
            for (let i = 0; i < riskData.length - 1; i++) {
                const start = riskData[i];
                const end = riskData[i + 1];
                const avgRisk = (start.risk + end.risk) / 2;
                
                const color = getHexColor(avgRisk);
                
                const segment = L.polyline(
                    [[start.lat, start.lng], [end.lat, end.lng]],
                    {
                        color: color,
                        weight: 8,
                        opacity: 0.8
                    }
                ).addTo(map);
                
                segment.bindPopup(`Risk: ${Math.round(avgRisk)}% - ${getRiskLevel(avgRisk)}`);
                routeRiskSegments.push(segment);
            }
            
            console.log('Route risk analysis complete!');
            alert(`üéâ Route Analysis Complete!\\n\\n‚úÖ Green segments = Low risk\\n‚ö†Ô∏è Yellow segments = Medium risk\\nüö® Red segments = High risk\\n\\nClick on any segment to see its risk score.`);
        }
        
        function clearRoute() {
            if (routeStartMarker) {
                map.removeLayer(routeStartMarker);
                routeStartMarker = null;
            }
            if (routeEndMarker) {
                map.removeLayer(routeEndMarker);
                routeEndMarker = null;
            }
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }
            routeRiskSegments.forEach(segment => map.removeLayer(segment));
            routeRiskSegments = [];
        }
        
        function exitRouteMode() {
            isRouteMode = false;
                analyzeRouteBtn.innerHTML = 'üõ£Ô∏è Analyze My Route';
                analyzeRouteBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                analyzeRouteBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-emerald-500', 'hover:from-green-600', 'hover:to-emerald-600');
            clearRoute();
        }
    </script>
</body>
</html>
